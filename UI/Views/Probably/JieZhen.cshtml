
@{
    ViewBag.Title = "JieZhen";
}

<h2>接诊</h2>


<style>

    body {
        /*background-color: LightBlue;*/
        font-family: Verdana;
        font-size: 13px;
    }

    .divHeaderTable {
        width: 100%;
        padding-bottom: 5px;
        display: block;
    }

    .divHeaderRow {
        width: 100%; /* add extra that you want to for header column */
        display: block;
        height: 105px;
    }

    .divHeaderColumn {
        float: left;
        width: 33%;
        display: block;
    }

    .divTable {
        width: 100%;
        display: block;
        padding-top: 10px;
        padding-bottom: 10px;
        padding-right: 10px;
        padding-left: 10px;
    }

    .divRow {
        width: 99%;
        display: block;
        padding-bottom: 5px;
    }

    .divColumn {
        float: left;
        width: 24%;
        display: block;
    }

    .form-control {
        display: block;
        width: 250px;
        height: 50px;
        padding: 6px 12px;
        font-size: 14px;
        line-height: 1.428571429;
        color: #555555;
        vertical-align: middle;
        background-color: #ffffff;
        border: 1px solid #cccccc;
        border-radius: 4px;
        -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
        -webkit-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
        transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
    }

    .button {
        display: inline-block;
        padding: 15px 25px;
        font-size: 24px;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        outline: none;
        color: #fff;
        background-color: #3c00ff;
        border: none;
        border-radius: 15px;
        box-shadow: 0 9px #999;
    }

        .button:hover {
            background-color: #3e8e41
        }

        .button:active {
            background-color: #3e8e41;
            box-shadow: 0 5px #666;
            transform: translateY(4px);
        }

    table {
        border-collapse: collapse;
        margin: 0 auto;
        text-align: center;
    }

        table td, table th {
            border: 1px solid #cad9ea;
            color: #666;
            height: 30px;
        }

        table thead th {
            background-color: #CCE8EB;
            width: 100px;
        }

        table tr:nth-child(odd) {
            background: #fff;
        }

        table tr:nth-child(even) {
            background: #F5FAFA;
        }

    .black_overlay {
        display: none;
        position: absolute;
        top: 0%;
        left: 0%;
        width: 100%;
        height: 100%;
        background-color: black;
        z-index: 1001;
        /*-moz-opacity: 0.8;*/
        opacity: .80;
        filter: alpha(opacity=88);
    }

    .white_content {
        display: none;
        position: absolute;
        top: 25%;
        left: 25%;
        width: 55%;
        height: 55%;
        padding: 20px;
        border: 10px solid orange;
        background-color: white;
        z-index: 1002;
        overflow: auto;
    }
    /*删除按钮css样式*/

    .info-close {
        /*position: fixed;*/
        right: calc(50% - 10px);
        width: 30px;
        height: 30px;
        background: #ff0000;
        opacity: .6;
        border-radius: 25px;
        cursor: pointer;
        z-index: 2002;
    }

        .info-close:before {
            position: absolute;
            content: '';
            width: 20px;
            height: 2px;
            background: white;
            transform: rotate(45deg);
            top: 14px;
            left: 5px;
        }

        .info-close:after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background: white;
            transform: rotate(-45deg);
            top: 14px;
            left: 5px;
        }
</style>
<div>
    <div id="divHeader" class="divHeaderTable">
        <h1 style="color:blue;margin-left: 40px">患者信息</h1>
    </div>
    <div id="content" class="divTable">
        <div class="divRow">
            <div class="divColumn">
                <div>
                    <label id="lblSolutation"> 患者姓名</label>
                </div>
                <div>
                    <input id="Name" type="text" class="form-control" placeholder="请填写患者姓名" />
                </div>
            </div>
            <div class="divColumn">
                <div>
                    <label id="lblFname"> 患者卡号</label>
                </div>
                <div>
                    <input id="Card" type="text" class="form-control" placeholder="请输入病人卡号" />
                </div>
            </div>
            <div class="divColumn">
                <div>
                    <label id="lblMname">患者年龄</label>
                </div>
                <div>
                    <input id="Age" type="text" class="form-control" placeholder="请输入数字" />
                </div>
            </div>
            <div class="divColumn">
                <div>
                    <label id="lblLname"> 出生日期</label>
                </div>
                <div>
                    <input id="Birthday" type="datetime-local" class="form-control" />
                </div>
            </div>
        </div>
        <div class="divRow">
            <div class="divColumn">
                <div>
                    <label id="Label9"> 性别</label>
                </div>
                <div>
                    <select id="Sex" class="form-control"></select>
                </div>

            </div>
            <div class="divColumn">
                <div>
                    <label id="Label7"> 手机号码</label>
                </div>
                <div>
                    <input id="Phone" class="form-control" type="text" placeholder="请输入手机号码" />
                </div>
            </div>
            <div class="divColumn">
                <div>
                    <label id="Label8"> 证件号码</label>
                </div>
                <div>
                    <input id="Number" type="text" class="form-control" placeholder="请输入证件号码" />
                </div>
            </div>
            <div class="divColumn">
                <div>
                    <label id="Label8"> 患者来源</label>
                </div>
                <div>
                    <select id="PatientSource" class="form-control">
                        <option>==请选择==</option>
                        <option>亲朋介绍</option>
                        <option>自己找的</option>
                        <option>报纸</option>
                        <option>网络</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="divRow">
            <div class="divColumn">
                <div>
                    <label id="Label9"> 会员类型</label>
                </div>
                <div>
                    <select id="VIPTypeId" class="form-control"></select>
                </div>

            </div>
            <div class="divColumn">
                <div>
                    <label id="Label7"> 挂号时间</label>
                </div>
                <div>
                    <input id="RegistrationTime" class="form-control" type="datetime-local" />
                </div>
            </div>
            <div class="divColumn">
                <div>
                    <label id="Label8"> 民族</label>
                </div>
                <div>
                    <input id="Ethnic" class="form-control" type="text" placeholder="请输入民族" />
                </div>
            </div>
            <div class="divColumn">
                <div>
                    <label id="Label8"> 婚姻状况</label>
                </div>
                <div>
                    <select id="MaritalStatus" class="form-control">
                        <option>==请选择==</option>
                        <option>已婚</option>
                        <option>未婚</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="divRow">
            <div class="divColumn">
                <div>
                    <label id="Label9"> 学历</label>
                </div>
                <div>
                    <select id="Education" class="form-control">
                        <option>==请选择==</option>
                        <option>小学</option>
                        <option>初中</option>
                        <option>高中</option>
                        <option>大专</option>
                        <option>本科</option>
                        <option>研究生</option>
                        <option>博士生</option>
                    </select>
                </div>

            </div>
            <div class="divColumn">
                <div>
                    <label id="Label8"> 地址</label>
                </div>
                <div>
                    <input id="Address" type="text" class="form-control" placeholder="请输入详细地址" />
                </div>
            </div>
            <div class="divColumn">
                <div>
                    <label id="Label8"> 备注</label>
                </div>
                <div>
                    <input id="Remark" class="form-control" type="text" />
                </div>
            </div>
        </div>
    </div>
</div>
<br />

<hr />
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title> </title>
    @*<link href="CSS/StyleSheet.css" rel="Stylesheet" type="text/css" />*@
</head>
<body>
   

    <table class="table" style="width:1400px" id="tab">
        <thead style="background:#a9c6c9">
            <tr>
                <th style="text-align:center;">
                    <input class="top2" type="checkbox" onclick="xuan2()" />
                </th>
                <th style="text-align:center;">药品编码</th>
                <th style="text-align:center;">药品名称</th>
                <th style="text-align:center;">售药价</th>
                <th style="text-align:center;">生产厂家</th>
                <th style="text-align:center;">药品数量</th>
                <th style="text-align:center;">创建时间</th>
                <th style="text-align:center;">药品类型</th>
                <th style="text-align:center;">操作</th>
            </tr>
        </thead>
        <tbody id="DrugShow" style="color:brown">
        </tbody>
    </table>

    <p>总价格合计:<span id="DrugSellingSum" style="color:red"></span>元</p>
    <div style="margin-left:700px;margin-top:50px;">
        <input id="Button1" class="button" type="button" value="添加药品" onclick="document.getElementById('light').style.display='block';document.getElementById('fade').style.display='block'" />
    </div>
    <h3><a href="#">打印药方</a></h3>
    <div style="margin-left:700px;margin-top:50px;">
        <input id="Button1" class="button" type="button" value="结束就诊" onclick="Update()" />
    </div>
    <div id="light" class="white_content">
        <a href="javascript:void(0)" onclick="document.getElementById('light').style.display='none';document.getElementById('fade').style.display='none'">点这里关闭本窗口</a>
        <br />
        <div style="margin-left:0px;margin-top:20px">
            <table>
                <tr>
                    <td>处方类别：</td>
                    <td>
                        <select id="DrugTypeId" class="form-control">
                            <option></option>
                        </select>
                    </td>
                    <td><input id="DrugName" type="text" class="form-control" placeholder="请输入药品名字" /></td>
                    <td><input id="Button1" type="button" value="查询啊" class="btn btn-danger" onclick="DrugShow(1)" /></td>
                </tr>
            </table>
        </div>
        <table class="table">
            <thead style="background:#a9c6c9">
                <tr>
                    <th style="text-align:center;">
                        <input class="top" type="checkbox" onclick="xuan()" />
                    </th>
                    <th style="text-align:center;">序号</th>
                    <th style="text-align:center;">药品编码</th>
                    <th style="text-align:center;">药品名称</th>
                    <th style="text-align:center;">药品类别</th>
                    <th style="text-align:center;">规格</th>
                    <th style="text-align:center;">生产厂家</th>
                    <th style="text-align:center;">库存</th>
                    <th style="text-align:center;">采购价格</th>
                    <th style="text-align:center;">零售价格</th>
                </tr>
            </thead>
            <tbody id="td" style="color:brown">
            </tbody>
        </table>
        总记录数<span id="TotalCount"></span>条&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        总共<span id="TotalPage"></span>页&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        当前第<span id="CurrentPage"></span>页&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a href="javascript:;" onclick="DrugShow(1)">首页</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a href="javascript:;" onclick="DrugShow(CurrentPage-1)">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a href="javascript:;" onclick="DrugShow(CurrentPage+1)">下一页</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a href="javascript:;" onclick="DrugShow(TotalPage)">尾页</a>
        <input id="Button1" class="button" type="button" value="确定" onclick="DrugRepertoryAdd()" />
        <input id="Button1" class="button" type="button" value="取消" onclick="location.href='/Probably/WorkBench'" />
    </div>
    <div id="fade" class="black_overlay"></div>

    <div style="text-align:center; background-color:aqua;margin-top:100px">欢迎登陆医院系统</div>
</body>
</html>
<script src="~/Scripts/My97DatePicker/My97DatePicker/WdatePicker.js"></script>
@section scripts{

    <script>
         function Delete(id) {
        if (confirm("患者信息删除后无法恢复，确定删除吗？")) {
            $.ajax({
                url: "http://localhost:65510/api/Patients/Delete/" + @ViewContext.RouteData.Values["id"],
                type: "post",
                data: { id: id },
                success: function (d) {
                    if (d > 0) {
                        alert("删除成功！");
                        Select();
                    }
                    else {
                        alert("删除失败！");
                    }
                }
            })
        }
    }


        $(function () {
            SexBand();
            VIP();
        })
        //性别
        function SexBand() {
            $.ajax({
                url: "http://localhost:65510/api/Sex/Get/",
                type: "get",
                success: function (d) {
                    $("#Sex").empty();
                    $("#Sex").append("<option value=''>==请选择==</option>");
                    $(d).each(function () {
                        var opt = '<option value="' + this.Id + '">' + this.SexName + '</option>';
                        $("#Sex").append(opt);
                    })
                }
            })
        }
        //会员等级
        function VIP() {
            $.ajax({
                url: "http://localhost:65510/api/BrandSetting/Get/",
                type: "get",
                success: function (d) {
                    Select();
                    $("#VIPTypeId").empty();
                    $("#VIPTypeId").append("<option value=''>==请选择==</option>");
                    $(d).each(function () {
                        var opt = '<option value="' + this.SettingId + '">' + this.SettingGrade + '</option>';
                        $("#VIPTypeId").append(opt);
                    })
                }
            })
        }
        //反填患者信息
    function Select() {
        $.ajax({
            url: "http://localhost:65510/api/Patients/Get/"+ @ViewContext.RouteData.Values["id"],
            type: "get",
            success: function (d) {
                $("#Name").val(d.PatientName);
                $("#Card").val(d.PatientCard);
                $("#Age").val(d.PatientAge);
                $("#Birthday").val(d.Birthdate);
                $("#Sex").val(d.PatientSexId);
                $("#Phone").val(d.PatientPhone);
                $("#Number").val(d.CertificateNumber);
                $("#PatientSource").val(d.PatientSource);
                $("#VIPTypeId").val(d.VIPTypeId);
                $("#RegistrationTime").val(d.RegistrationTime);
                $("#Ethnic").val(d.Ethnic);
                $("#MaritalStatus").val(d.MaritalStatus);
                $("#Education").val(d.Education);
                $("#Address").val(d.SiteTionContent);
                $("#Remark").val(d.Remark);
                }
        })
    }
    //编辑患者信息
        function Update() {
            var id = @ViewContext.RouteData.Values["id"];
            var obj = {};
            obj.PatientName = $("#Name").val();
            obj.PatientCard = $("#Card").val();
            obj.PatientAge = $("#Age").val();
            obj.Birthdate = $("#Birthday").val();
            obj.PatientSexId = $("#Sex").val();
            obj.PatientPhone = $("#Phone").val();
            obj.CertificateNumber = $("#Number").val();
            obj.PatientSource = $("#PatientSource").val();
            obj.VIPTypeId = $("#VIPTypeId").val();
            obj.RegistrationTime = $("#RegistrationTime").val();
            obj.Ethnic = $("#Ethnic").val();
            obj.MaritalStatus = $("#MaritalStatus").val();
            obj.Education = $("#Education").val();
            obj.SiteTionContent = $("#Address").val();
            obj.Remark = $("#Remark").val();
            obj.Id = id;
            $.ajax({
                url: "http://localhost:65510/api/Patients/Put/",
                type: "post",
                data: obj,
                success: function (d) {
                    if (d > 0) {

                        Delete();
                        location.href = "/Patients/PatientsShow";
                    }
                    else {
                        alert("失败！");
                    }
                }
            })
    }
     $(function () {
            RoleBandsel();
            RepertoryTypeBandsel();
            ManufacturersBandsel();
            DrugTypeBandsel();

        });
        //绑定入库人员表
        function RoleBandsel() {
            $.ajax({
                url: 'http://localhost:65510/api/Role/Get',
                type: 'get',
                dataType: 'json',
                success: function (d) {
                    $("#RoleName").empty();
                    $("#RoleName").append("<option value=''>==请选择==</option>");
                    $(d).each(function () {
                        var opt = "<option value='" + this.Id + "'>" + this.CreatePerson + "</option>";
                        $("#RoleName").append(opt);
                    })
                }
            })
        }
        //绑定入库类型表
        function RepertoryTypeBandsel() {
            $.ajax({
                url: 'http://localhost:65510/api/RepertoryType/Get',
                type: 'get',
                dataType: 'json',
                success: function (d) {
                    $("#RepertoryTypeName").empty();
                    $("#RepertoryTypeName").append("<option value=''>==请选择==</option>");
                    $(d).each(function () {
                        var opt = "<option value='" + this.Id + "'>" + this.RepertoryTypeName + "</option>";
                        $("#RepertoryTypeName").append(opt);
                    })
                }
            })
        }
        //绑定生产厂家
        function ManufacturersBandsel() {
            $.ajax({
                url: 'http://localhost:65510/api/Manufacturers/Get',
                type: 'get',
                dataType: 'json',
                success: function (d) {
                    $("#ManufacturersName").empty();
                    $("#ManufacturersName").append("<option value=''>==请选择==</option>");
                    $(d).each(function () {
                        var opt = "<option value='" + this.Id + "'>" + this.ManufacturersName + "</option>";
                        $("#ManufacturersName").append(opt);
                    })
                    DrugShow(1);
                    DrugRepertoryShow();
                }
            })
        }
        var PageSize = 6;
        var CurrentPage = 1;
        var TotalPage = 1;
        //显示药品表
        function DrugShow(page) {
            var obj = {};
            obj.DrugTypeId = $("#DrugTypeId").val();
            obj.DrugName = $("#DrugName").val();
            obj.CurrentPage = page;
            obj.PageSize = PageSize;
            $.ajax({
                url: 'http://localhost:65510/api/Drug/Get',
                type: 'get',
                data:obj,
                dataType: 'json',
                success: function (d) {

                    $("#TotalCount").text(d.TotalCount)
                    $("#TotalPage").text(d.TotalPage)
                    $("#CurrentPage").text(d.CurrentPage)
                    //最大页
                    TotalPage = d.TotalPage;
                    //当前页
                    CurrentPage = d.CurrentPage;

                    $("#td").empty();
                    $(d.drugs).each(function () {
                        var line = '<tr>'
                            + '<td><input class="cktop" type="checkbox" value=' + this.Id + ' /></td>'
                            + '<td>' + this.Id + '</td>'
                            + '<td>' + this.DrugNumber + '</td>'
                            + '<td>' + this.DrugName + '</td>'
                            + '<td>' + this.DrugTypeName + '</td>'
                            + '<td>' + this.Specification + '</td>'
                            + '<td>' + this.ManufacturersName + '</td>'
                            + '<td>' + this.InventoryUpperLimit + '</td>'
                            + '<td>' + this.DrugPrice + '</td>'
                            + '<td>' + this.DrugSelling + '</td>'
                            + '</tr>'
                        $("#td").append(line);
                    })
                }
            })
        }

        //全选和反选(药品表)
        function xuan() {
            if ($(".top").prop("checked")) {
                $(".cktop").prop("checked", true);
            }
            else {
                $(".cktop").each(function () {
                    this.checked = !this.checked;
                })
            }
        }
        //绑定处方类别
        function DrugTypeBandsel() {
            $.ajax({
                url: 'http://localhost:65510/api/DrugType/Get',
                type: 'get',
                dataType: 'json',
                success: function (d) {
                    $("#DrugTypeId").empty();
                    $("#DrugTypeId").append("<option value=''>==请选择==</option>");
                    $(d).each(function () {
                        var opt = "<option value='" + this.Id + "'>" + this.DrugTypeName + "</option>";
                        $("#DrugTypeId").append(opt);
                    })
                    DrugShow(1);
                }
            })
        }


        //选中药品添加到库存
        function DrugRepertoryAdd()
        {
            var ids = [];
            $(".cktop:checked").each(function () {
                ids.push(this.value);
            });
            if (ids.length == 0) {
                alert("请选择药品");
                return;
            }
            $.ajax({
                url: 'http://localhost:65510/api/DrugRepertory/Post',
                type: 'post',
                data: { Id:ids.toString()},
                //data: JSON.stringify(ids),
                dataType: 'json',
                success: function (d) {
                    if(d > 0)
                    {
                        alert("添加药品成功");
                        DrugRepertoryShow();
                        

                    }
                    else
                    {
                        alert("添加药品失败");
                    }
                }
            })

        }
        //显示药品入库信息
        function DrugRepertoryShow() {
            $.ajax({
                url: 'http://localhost:65510/api/DrugRepertory/Get',
                type: 'get',
                dataType: 'json',
                success: function (d) {

                    $("#DrugShow").empty();
                    $(d).each(function () {
                        var line = '<tr>'
                            + '<td><input class="cktop2" type="checkbox" value=' + this.Id + ' /></td>'
                            + '<td>' + this.DrugNumber + '</td>'
                            + '<td>' + this.DrugName + '</td>'
                            + '<td>' + this.DrugSelling + '</td>'
                            + '<td>' + this.ManufacturersName + '</td>'
                            + '<td>' + this.DrugCount+ '</td>'
                            + '<td>' + this.DrugCreateTime + '</td>'
                            + '<td>' + this.DrugTypeName + '</td>'
                            +'<td><input id="Button1" class="info-close" type="button" style="color:blue" value="×" onclick=DrugRepertoryDel('+this.Id+') /></td>'
                            + '</tr>'
                        $("#DrugShow").append(line);
                        //零售金额合计
                        var sum2 = 0;
                        var tableId = document.getElementById("tab");
                        for (var i = 0; i < tableId.rows.length; i++) {
                            var a = Number(tableId.rows[i].cells[3].innerHTML) || 0;
                            sum2 += a;
                        }
                        var demoP = document.getElementById("DrugSellingSum");
                        demoP.innerHTML = + sum2;
                    })
                }
            })
        }

        //删除药品入库信息
        function DrugRepertoryDel(Id)
        {
            if (confirm("确认要删除吗？"))
            {
                $.ajax({
                    url: 'http://localhost:65510/api/DrugRepertory/Delete/' + Id,
                    type: 'Post',
                    data: { Id: Id },
                    dataType: 'json',
                    success: function (d) {
                        if (d > 0) {
                            alert('删除成功');
                            DrugRepertoryShow();
                        }
                        else {
                            alert('删除失败');
                        }
                    }
                })
            }
        }
        //全选和反选(药品入库信息)
        function xuan2() {
            if ($(".top2").prop("checked")) {
                $(".cktop2").prop("checked", true);
            }
            else {
                $(".cktop2").each(function () {
                    this.checked = !this.checked;
                })
            }
        }
        //直接入库
        function RepertoryAdd()
        {
            var ids = [];
            $(".cktop2:checked").each(function () {
                ids.push(this.value);
            });
            if (ids.length == 0) {
                alert("请选择药品");
                return;
            }
            var obj = {};
            obj.RepertoryNumber = $("#RepertoryNumber").val();
            obj.RepertoryTime = $("#RepertoryTime").val();
            obj.RoleId = $("#RoleName").val();
            obj.RepertoryTypeId = $("#RepertoryTypeName").val();
            obj.ManufacturersId = $("#ManufacturersName").val();
            obj.RepertoryNumber = $("#RepertoryNumber").val();
            obj.Remark = $("#Remark").val();
            obj.DrugRepertoryId = ids;

            $.ajax({
                url: 'http://localhost:65510/api/Repertory/Post',
                type: 'post',
                data: obj,
                dataType: 'json',
                success: function (d) {
                    if (d > 0) {
                        alert('药品入库成功');
                        location.href = '/Repertory/RepertoryShow';
                    }
                    else {
                        alert('药品入库失败');
                    }
                }
            })
        }

        //新增入库提交审核
        function RepertoryAddStatus() {
            var ids = [];
            $(".cktop2:checked").each(function () {
                ids.push(this.value);
            });
            if (ids.length == 0) {
                alert("请选择药品");
                return;
            }
            var obj = {};
            obj.RepertoryNumber = $("#RepertoryNumber").val();
            obj.RepertoryTime = $("#RepertoryTime").val();
            obj.RoleId = $("#RoleName").val();
            obj.RepertoryTypeId = $("#RepertoryTypeName").val();
            obj.ManufacturersId = $("#ManufacturersName").val();
            obj.RepertoryNumber = $("#RepertoryNumber").val();
            obj.Remark = $("#Remark").val();
            obj.DrugRepertoryId = ids;

            $.ajax({
                url: 'http://localhost:65510/api/RepertoryAddStatus/Post',
                type: 'post',
                data: obj,
                dataType: 'json',
                success: function (d) {
                    if (d > 0) {
                        alert('药品入库成功');
                        location.href = '/Repertory/RepertoryShow';
                    }
                    else {
                        alert('药品入库失败');
                    }
                }
            })
        }
    </script>
}


